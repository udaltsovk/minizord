defaults
    mode http
    option httplog
    option dontlognull
    timeout connect 5000
    timeout client 50000
    timeout server 50000

frontend http_frontend
    bind *:8080
    # For SSL, add: bind *:4343 ssl crt /etc/ssl/yourdomain.pem

    # Compression configuration
    compression algo gzip
    compression type text/html text/plain text/css application/javascript

    # Path normalization
    # normalize-uri path-merge-slashes

    use_backend backend_api if { path /api } || { path_beg /api/ }
    use_backend backend_grafana if { path /grafana } || { path_beg /grafana/ }
    default_backend backend_frontend

backend backend_frontend
    server frontend_server grafana:3000 check

backend backend_grafana
    http-request replace-path /grafana(/)?(.*) /\2
    server grafana_server grafana:3000 check

backend backend_api
    http-request replace-path /api(/)?(.*) /\2

    # Request size limits
    # http-request deny if { req.hdr_len gt 10240 }  # Header size > 10KB
    # http-request deny if { req.body_size gt 10485760 }  # Body size > 10MB
    timeout http-request 10s  # Time to receive complete request

    server api_server api:8080 check
